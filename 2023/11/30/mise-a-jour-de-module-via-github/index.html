<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mise à jour de module via GitHub | Blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="alternate" type="application/rss+xml" href="https://prestaedit.github.io/rss.xml" title="Blog RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://prestaedit.github.io/feed.atom" title="Blog Atom Feed">
    <link rel="alternate" type="application/json" href="https://prestaedit.github.io/feed.json" title="Blog JSON Feed">
    <meta name="description" content="Voyons comment publier un module open-source sous PrestaShop 8 avec détection de mise à jour intégrée">
    
    <link rel="preload" href="/assets/css/0.styles.a128e09c.css" as="style"><link rel="preload" href="/assets/js/app.ed9e6311.js" as="script"><link rel="preload" href="/assets/js/6.20402219.js" as="script"><link rel="preload" href="/assets/js/3.d4855d28.js" as="script"><link rel="preload" href="/assets/js/24.f82cd95c.js" as="script"><link rel="preload" href="/assets/js/8.14af2056.js" as="script"><link rel="preload" href="/assets/js/9.0ace11ef.js" as="script"><link rel="prefetch" href="/assets/js/10.bb2f099b.js"><link rel="prefetch" href="/assets/js/11.3e9d7140.js"><link rel="prefetch" href="/assets/js/12.9c8dc221.js"><link rel="prefetch" href="/assets/js/13.f57a86c2.js"><link rel="prefetch" href="/assets/js/14.b43af2a7.js"><link rel="prefetch" href="/assets/js/15.2ebf831f.js"><link rel="prefetch" href="/assets/js/16.4cff3acc.js"><link rel="prefetch" href="/assets/js/17.975e070b.js"><link rel="prefetch" href="/assets/js/18.1784ef09.js"><link rel="prefetch" href="/assets/js/19.012da42d.js"><link rel="prefetch" href="/assets/js/20.8e21f36d.js"><link rel="prefetch" href="/assets/js/21.f820d3fb.js"><link rel="prefetch" href="/assets/js/22.ae8adf91.js"><link rel="prefetch" href="/assets/js/23.45ca190c.js"><link rel="prefetch" href="/assets/js/25.388e0cad.js"><link rel="prefetch" href="/assets/js/26.548acc29.js"><link rel="prefetch" href="/assets/js/27.97eb3cf8.js"><link rel="prefetch" href="/assets/js/28.42bba965.js"><link rel="prefetch" href="/assets/js/29.407cb73e.js"><link rel="prefetch" href="/assets/js/30.b30a3da1.js"><link rel="prefetch" href="/assets/js/31.277e0b5c.js"><link rel="prefetch" href="/assets/js/4.bc18d80a.js"><link rel="prefetch" href="/assets/js/5.20fad23a.js"><link rel="prefetch" href="/assets/js/7.560bedc2.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.49676877.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a128e09c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><nav class="navbar navbar-expand-md navbar-light bg-white fixed-top"><div class="container"><a href="/" class="navbar-brand"><img src="/assets/img/logo.png"> | Blog
          </a> <button type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler"><span class="navbar-toggler-icon"></span></button> <div id="navbarsExampleDefault" class="collapse navbar-collapse"><ul class="navbar-nav ml-auto"><li class="nav-item"><a href="/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <a href="./rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></ul></div></div></nav></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="mobile-home-link navbar-brand"><img src="/assets/img/logo.png"> Blog
      </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/">Blog</a></li><li class="mobile-nav-item"><a href="/tag/">Tags</a></li> <li class="mobile-nav-item"><a href="./rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul></div></div></div> <div class="container wrapmain"><div id="vuepress-theme-blog__post-layout" data-v-d07ae2ee><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content" data-v-d07ae2ee><div class="row justify-content-center" data-v-d07ae2ee><div class="col-md-8" data-v-d07ae2ee><header data-v-d07ae2ee><span class="text-muted" data-v-d07ae2ee><div class="post-meta" data-v-d07ae2ee><!----> <div class="post-meta-date"><time pubdate itemprop="datePublished" datetime="2023-11-30T00:00:00.000Z">
      30 novembre 2023
    </time></div> <!----></div></span> <h1 itemprop="name headline" class="article-head mt-3" data-v-d07ae2ee>
            Mise à jour de module via GitHub
          </h1> <p class="lead" data-v-d07ae2ee>Voyons comment publier un module open-source sous PrestaShop 8 avec détection de mise à jour intégrée</p> <div class="post-meta" data-v-d07ae2ee><!----> <!----> <div itemprop="keywords" class="card-subheading post-meta-tags"><a href="/tag/Outils" data-v-304a57ff> Outils </a><a href="/tag/Prestashop Dev Conference" data-v-304a57ff> Prestashop Dev Conference </a></div></div></header></div></div> <div class="row justify-content-center text-center mt-2 mb-2" data-v-d07ae2ee></div> <div class="row justify-content-center" data-v-d07ae2ee><div class="col-md-8" data-v-d07ae2ee><div itemprop="articleBody" class="content__default" data-v-d07ae2ee><div class="alert alert-info">
  Cet article nécessite PrestaShop 8.
</div> <h2 id="preambule"><a href="#preambule" class="header-anchor">#</a> Préambule</h2> <p><strong>PrestaShop 8</strong> dispose d'une particularité vis-à-vis des versions précedentes : cette version de PrestaShop n'est plus étroitement liée à la marketplace <strong>PrestaShop Addons</strong>.</p> <p>Précédemment, les modules natifs - et donc gratuit - de PrestaShop étaient stockés sur cette plateforme afin de permettre notamment le téléchargement des modules à l'installation d'une boutique ou encore d'obtenir les informations de nouvelles versions disponibles.</p> <p>Lors du déploiement d'une boutique PrestaShop, il est possible de choisir deux versions de PrestaShop :</p> <ul><li><strong>Basic</strong> : la version open-source, packagée depuis GitHub ;</li> <li><strong>Edition</strong> : basée sur la version <em>Basic</em>, avec un style différent et un couplage à Addons intégré.</li></ul> <p>Quoi de plus attendu qu'une version packagée via GitHub pour être en lien avec des modules eux-même packagés et releasés sur cette même plateforme ?</p> <p>C'est précisement la raison pour laquelle un nouveau module est apparu - <em>ps_distributionapi</em> - permettant ainsi de <strong>distribuer les modules natifs au fil des publications de mise à jours et de versions de PrestaShop</strong>.</p> <p>Et bien que nous soyons en mesure d'accomplir pas mal de miracles dans nos développements en se basant sur un PrestaShop classique, il n'en est pas moins nécessaire de réaliser des adaptations en conséquences.</p> <h2 id="de-nouveaux-hooks"><a href="#de-nouveaux-hooks" class="header-anchor">#</a> De nouveaux hooks</h2> <p>Dès lors, de nombreux hooks ont été introduits pour faciliter la gestion des modules à présenter - <em>aussi bien ceux présents physiquements que ceux disponibles au téléchargement</em> - sur la page de gestion des modules.</p> <p>On compte pas moins de <strong>dix</strong> nouveaux hooks :</p> <ul><li><code>actionListModules</code></li> <li><code>actionBeforeInstallModule</code></li> <li><code>actionBeforePostInstallModule</code></li> <li><code>actionBeforeUninstallModule</code></li> <li><code>actionBeforeUpgradeModule</code></li> <li><code>actionBeforeEnableModule</code></li> <li><code>actionBeforeDisableModule</code></li> <li><code>actionBeforeEnableMobileModule</code></li> <li><code>actionBeforeDisableMobileModule</code></li> <li><code>actionBeforeResetModule</code></li></ul> <p>Ces nouveaux hooks sont bien entendus gérés par le module de PrestaShop de distribution des modules (<em>ps_distributionapi</em>) mais ils ne lui sont pas reservés.</p> <p>Je vous invite notamment à visualiser la <a href="https://github.com/PrestaShop/PrestaShop/pull/27632" target="_blank" rel="noopener noreferrer">Pull Request<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> concernée par cette nouveauté ainsi que la <a href="https://www.youtube.com/live/jNSKKaTySyQ?si=YnrrSfMApFuVjXKE&amp;t=242" target="_blank" rel="noopener noreferrer">démonstration<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ayant eue lieue le 06 avril 2012.</p> <h2 id="implementation-technique"><a href="#implementation-technique" class="header-anchor">#</a> Implémentation technique</h2> <p>Dans le contexte de notre besoin, à savoir de pousser une mise à jour de module packagé sous GitHub, nous sommes confrontés à un élément de taille : <strong>comment déceler qu'une nouvelle version est disponible</strong> et, surtout, <strong>comment permettre au marchand d'installer celle-ci en un clic</strong> ?</p> <h3 id="premiere-approche-standalone"><a href="#premiere-approche-standalone" class="header-anchor">#</a> Première approche : standalone</h3> <p>Vous développez peu de modules open-source disponible gratuitement via GitHub ou vous n'avez pas envie de forcer l'utilisation d'un module tiers en supplément de votre module ; vous allez donc proposer une <strong>approche intégrée</strong>.</p> <p>Dans cette approche, nous partirons d'un postulat : le marchand dispose d'ores et déjà d'une version installée de votre module et seules les mises à jours doivent être traitées. La découverte et l'installation de modules non présents sur le disque sera donc exclue.</p> <h4 id="etape-prealable"><a href="#etape-prealable" class="header-anchor">#</a> Etape préalable</h4> <p>Dans l'approche souhaitée, nous utilisons la gestion des <code>releases</code> fournies par GitHub.</p> <p>Nous souhaitons par la même occasion utiliser les différents assets disponibles sur une release donnée, afin de fournir une archive ZIP en bonne et due forme, attendue par PrestaShop pour la mise à jour d'un module.</p> <p>Nous nous baserons donc sur une action GitHub utilisée par PrestaShop sur les modules open-source : le <code>build release</code>.</p> <p>Dans votre dépot GitHub, vous aurez dès lors le fichier suivant : <code>.github/workflows/build-release.yml</code>.</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">name</span><span class="token punctuation">:</span> Build
<span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>push<span class="token punctuation">,</span> pull_request<span class="token punctuation">]</span>

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">build-and-release-draft</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> Build &amp; Release draft
    <span class="token key atrule">uses</span><span class="token punctuation">:</span> PrestaShop/.github/.github/workflows/build<span class="token punctuation">-</span>release.yml@master
</code></pre></div><p>Une série d'actions sera réalisée par ce <a href="https://github.com/PrestaShop/.github/blob/3efc27189527a7a9b9b0c0305501bf5146029289/.github/workflows/build-release.yml" target="_blank" rel="noopener noreferrer">workflow<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> afin notamment de nettoyer l'archive de fichiers et dossiers de tests ou encore d'ajouter automatiquement les <code>index.php</code> manquants.</p> <div class="alert alert-warning">
  Ce workflow nécessite l'ajout d'un secret sur votre repository : GITHUB_TOKEN.
</div> <p>De plus, vous aurez également le fichier suivant : <code>.github/release-drafter.yml</code>.</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">branches</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> master
  <span class="token punctuation">-</span> main
<span class="token key atrule">name-template</span><span class="token punctuation">:</span> v$NEXT_PATCH_VERSION
<span class="token key atrule">tag-template</span><span class="token punctuation">:</span> v$NEXT_PATCH_VERSION
<span class="token key atrule">categories</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">title</span><span class="token punctuation">:</span> 🚀 Features
    <span class="token key atrule">label</span><span class="token punctuation">:</span> features 🚀
  <span class="token punctuation">-</span> <span class="token key atrule">title</span><span class="token punctuation">:</span> ✨ Improvements
    <span class="token key atrule">label</span><span class="token punctuation">:</span> enhancement ✨
  <span class="token punctuation">-</span> <span class="token key atrule">title</span><span class="token punctuation">:</span> 🐞 Bug Fixes
    <span class="token key atrule">label</span><span class="token punctuation">:</span> bug 🐞
<span class="token key atrule">change-template</span><span class="token punctuation">:</span> <span class="token string">'- #$NUMBER: $TITLE by @$AUTHOR'</span>
<span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
  # Changes
  $CHANGES</span>
</code></pre></div><p>Il servira de modèle de template pour la release ; libre à vous de le modifier comme vous l'entendez.</p> <div class="alert alert-info">
  Désormais, chaque pull request associée à la branche main/master permettra d'actualiser une release draft.
</div> <h4 id="implementation-du-trait"><a href="#implementation-du-trait" class="header-anchor">#</a> Implémentation du trait</h4> <div class="alert alert-warning">
  Dans la suite de l'article, nous allons rencontrer plusieurs issues. Cette implémentation va donc varier au fil de l'article.
</div> <p>Dans ce trait, nous allons donc récupérer la dernière release d'un repository donné - ce y compris son changelog - et le retourner en informations à la page de gestion des modules.</p> <p>On placera le code de ce dernier dans le fichier <code>src/PrestaShop/Module/UpgradeManager.php</code>.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">PrestaShop<span class="token punctuation">\</span>Module</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Exception</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Tools</span><span class="token punctuation">;</span>

<span class="token keyword">trait</span> <span class="token class-name-definition class-name">UpgradeManager</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'actionListModules'</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return string
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">getRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword return-type">string</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$githubRepository</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$githubRepository</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return string
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">getUpgradeURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword return-type">string</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'https://api.github.com/repos/%s/releases/latest'</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function-definition function">getGithubHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'http'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
          <span class="token string single-quoted-string">'method'</span><span class="token operator">=&gt;</span> <span class="token string double-quoted-string">&quot;GET&quot;</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'header'</span><span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
            <span class="token string double-quoted-string">&quot;Accept: application/vnd.github+json&quot;</span><span class="token punctuation">,</span>
            <span class="token string double-quoted-string">&quot;X-GitHub-Api-Version: 2022-11-28&quot;</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">getLatestRelease</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token variable">$upgradeModuleURL</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getUpgradeURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$upgradeModuleURL</span> <span class="token operator">==</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token variable">$latestRelease</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">file_get_contents_curl</span><span class="token punctuation">(</span><span class="token variable">$upgradeModuleURL</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getGithubHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token variable">$latestRelease</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token constant">JSON_THROW_ON_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tag_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'version_available'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'v'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tag_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'download_url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getDownloadUrl</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'changeLog'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getChangelog</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dump</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token variable">$latestRelease</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">getModuleData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token variable">$latestRelease</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getLatestRelease</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token variable">$module</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'version_available'</span> <span class="token operator">=&gt;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'version_available'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'version_available'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">version</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'download_url'</span> <span class="token operator">=&gt;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'download_url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'download_url'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'additional_description'</span> <span class="token operator">=&gt;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'additional_description'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'additional_description'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'url_active'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'upgrade'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'changeLog'</span> <span class="token operator">=&gt;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'changeLog'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'changeLog'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token constant">null</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'urls'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'upgrade'</span> <span class="token operator">=&gt;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'download_url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'download_url'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'productType'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'module'</span><span class="token punctuation">,</span> <span class="token comment">// module, service</span>
      <span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token variable">$module</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getDownloadUrl</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'assets'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'assets'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'assets'</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$asset</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$assetName</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'.zip'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$asset</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string single-quoted-string">'application/zip'</span> <span class="token operator">==</span> <span class="token variable">$asset</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content_type'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">==</span> <span class="token variable">$assetName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token variable">$asset</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'browser_download_url'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getChangelog</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'body'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token variable">$lines</span> <span class="token operator">=</span> <span class="token function">preg_split</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;/\r\n|\n|\r/&quot;</span><span class="token punctuation">,</span> <span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'body'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$lines</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token variable">$changelog</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'version_available'</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
          <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$lines</span> <span class="token keyword">as</span> <span class="token variable">$line</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$line</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string double-quoted-string">&quot;-&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token variable">$line</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'-'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$line</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token variable">$changelog</span><span class="token punctuation">[</span><span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'version_available'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$line</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token variable">$changelog</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return array&lt;array&lt;string, string&gt;&gt;
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">hookActionListModules</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">array</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token variable">$modules</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token variable">$module</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getModuleData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$module</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$modules</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$module</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token variable">$modules</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @param string $url
     * @param int $curl_timeout
     * @param array $opts
     *
     * @return bool|string
     *
     * @throws Exception
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">file_get_contents_curl</span><span class="token punctuation">(</span>
      <span class="token variable">$url</span><span class="token punctuation">,</span>
      <span class="token variable">$curl_timeout</span><span class="token punctuation">,</span>
      <span class="token variable">$opts</span><span class="token punctuation">,</span>
      <span class="token variable">$user_agent</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'PrestaShop-ModuleAutoUpgrade'</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'curl_init'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name static-context">Tools</span><span class="token operator">::</span><span class="token function">refreshCACertFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token variable">$curl</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_RETURNTRANSFER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_CONNECTTIMEOUT</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_TIMEOUT</span><span class="token punctuation">,</span> <span class="token variable">$curl_timeout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_SSL_VERIFYPEER</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_CAINFO</span><span class="token punctuation">,</span> <span class="token constant">_PS_CACHE_CA_CERT_FILE_</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_FOLLOWLOCATION</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_MAXREDIRS</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_USERAGENT</span><span class="token punctuation">,</span> <span class="token variable">$user_agent</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$opts</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'http'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'header'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HTTPHEADER</span><span class="token punctuation">,</span> <span class="token variable">$opts</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'http'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'header'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant boolean">false</span> <span class="token operator">===</span> <span class="token variable">$content</span> <span class="token operator">&amp;&amp;</span> <span class="token constant">_PS_MODE_DEV_</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$errorMessage</span> <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'file_get_contents_curl failed to download %s : (error code %d) %s'</span><span class="token punctuation">,</span>
              <span class="token variable">$url</span><span class="token punctuation">,</span>
              <span class="token function">curl_errno</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token function">curl_error</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Exception</span><span class="token punctuation">(</span><span class="token variable">$errorMessage</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token variable">$content</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre></div><p>On utilise dès lors uniquement un seul des nouveaux hooks disponibles : <code>actionListModules</code>.</p> <h4 id="utilisation"><a href="#utilisation" class="header-anchor">#</a> Utilisation</h4> <p>On va désormais pouvoir importer ce <strong>trait</strong> via l'autoload <code>Composer</code> et l'utiliser dans la classe principale du module.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;prestaedit/test&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Your module with AutoUpgrade management&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;autoload&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;psr-4&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;PrestaShop\\Module\\&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/PrestaShop/Module/&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;prestashop-module&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Bien entendu, ceci est un extrait de votre potentiel fichier <code>composer.json</code> et je vous invite vivement à modifier le namespace utilisé pour le rendre unique, par exemple en le préfixant du nom de votre module.</p> <p>Partir sur un <em>trait</em> permet d'éviter de devoir modifier la classe que l'on souhaite étendre et de faire appel au parent lors de l'installation.</p> <p>Notre méthode d'installation ayant toutefois le même nom, on l'importera sous un <strong>alias</strong>.
Cet alias sera ensuite appellé dans notre méthode d'installation.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'_PS_VERSION_'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token constant">__DIR__</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/vendor/autoload.php'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">require_once</span> <span class="token constant">__DIR__</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/vendor/autoload.php'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">use</span> <span class="token package">PrestaShop<span class="token punctuation">\</span>Module<span class="token punctuation">\</span>UpgradeManager</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Test</span> <span class="token keyword">extends</span> <span class="token class-name">Module</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token package">UpgradeManager</span> <span class="token punctuation">{</span>
        install <span class="token keyword">as</span> <span class="token keyword">protected</span> upgradeManagerInstall<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token variable">$githubRepository</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'PrestaEdit/test'</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'test'</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">displayName</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">trans</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Test'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Modules.Test.Admin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">description</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">trans</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Description.'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Modules.Test.Admin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">author</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'PrestaEdit'</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">version</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'0.0.1'</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">ps_versions_compliancy</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'min'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'8.0.0'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'max'</span> <span class="token operator">=&gt;</span> <span class="token constant">_PS_VERSION_</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">bool</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">upgradeManagerInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre></div><p>Veuillez noter que nous avons également ajouter la déclaration de la variable <code>githubRepository</code> permettant de renseigner le repository concerné par le module.</p> <h4 id="probleme-n°1-le-rate-limit"><a href="#probleme-n°1-le-rate-limit" class="header-anchor">#</a> Problème n°1 : le rate limit</h4> <p>Un utilisateur <strong>non authentifié</strong> ; c'est-à-dire qu'il ne renseigne pas de token associé à son compte, sera <strong>limité à 60 requêtes</strong> par heure sur l'API Rest de GitHub.</p> <p>Si vous disposez d'un ensemble de modules se servant de cette mécanique et que vous ouvrez la page des modules qui aura pour effet de déclencher les hooks concernés - et dès lors un appel à l'API - plusieurs fois d'affilés, vous risquez fort d'atteindre rapidement cette limite.</p> <p>Pour cela, nous intégrons un cache à la requête effectué.</p> <div class="language-php extra-class"><pre class="language-php"><code>    <span class="token comment">/**
     * @return int
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">getCachedHours</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword return-type">int</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$cachedHours</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">72</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$cachedHours</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>Par défaut, une valeur de 72 heures (3 jours) est renseignée.
Vous pouvez modifier cette valeur sur votre module grâce à la propriété correspondante.</p> <div class="language-php extra-class"><pre class="language-php"><code>  <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token variable">$cachedHours</span> <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-php extra-class"><pre class="language-php"><code>  <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">getLatestRelease</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// Clé unique, restriction de caractères</span>
    <span class="token variable">$configurationId</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'ModuleAutoUpgrade_'</span> <span class="token operator">.</span> <span class="token class-name static-context">Tools</span><span class="token operator">::</span><span class="token function">hashIV</span><span class="token punctuation">(</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'_'</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name static-context">Configuration</span><span class="token operator">::</span><span class="token function">hasKey</span><span class="token punctuation">(</span><span class="token variable">$configurationId</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token variable">$upgradeModuleURL</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getUpgradeURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$upgradeModuleURL</span> <span class="token operator">==</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// [...]</span>

      <span class="token class-name static-context">Configuration</span><span class="token operator">::</span><span class="token function">updateValue</span><span class="token punctuation">(</span><span class="token variable">$configurationId</span><span class="token punctuation">,</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token variable">$latestRelease</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Delete cache, after n hours</span>
      <span class="token variable">$collection</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrestaShopCollection</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Configuration'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$collection</span><span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'='</span><span class="token punctuation">,</span> <span class="token variable">$configurationId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$configuration</span> <span class="token operator">=</span> <span class="token variable">$collection</span><span class="token operator">-&gt;</span><span class="token function">getLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$start_date</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span><span class="token variable">$configuration</span><span class="token operator">-&gt;</span><span class="token property">date_add</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$end_date</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$interval</span> <span class="token operator">=</span> <span class="token variable">$start_date</span><span class="token operator">-&gt;</span><span class="token function">diff</span><span class="token punctuation">(</span><span class="token variable">$end_date</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$interval</span><span class="token operator">-&gt;</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'%R%h'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'+'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getCachedHours</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name static-context">Configuration</span><span class="token operator">::</span><span class="token function">deleteByName</span><span class="token punctuation">(</span><span class="token variable">$configurationId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getLatestRelease</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token class-name static-context">Configuration</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$configurationId</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>Sans oublier de rajouter les nouveaux <code>use</code> correspondant :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">use</span> <span class="token package">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">DateTime</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">PrestaShopCollection</span><span class="token punctuation">;</span>
</code></pre></div><p>Bien entendu, une autre solution sera de renseigner un token, permettant de lever cette limite à <strong>5000 requêtes par heure</strong>.</p> <h4 id="probleme-n°2-le-type-mime"><a href="#probleme-n°2-le-type-mime" class="header-anchor">#</a> Problème n°2 : le type mime</h4> <p>Lorsque l'on récupère un asset via l'API de GitHub ou par le biais de son URL direct (fournie en tant que <code>broswer_url</code> dans les informations de l'asset), nous sommes confrontés au même soucis : <strong>le type mime</strong> renvoyé est <code>application/octet-stream</code>.</p> <p>Or, les deux <code>SourceHandler</code> fournit par PrestaShop travaillent soit avec une archive locale soit une archive distante dont le type mime renvoyé est <strong>obligatoirement</strong> <code>application/zip</code>.</p> <p>Nous ne pouvons donc malheureusement pas nous appuyer sur le <code>RemoteZipSourceHandler</code> et sommes obligés de basculer sur le <code>ZipSourceHandler</code> qui traitera un fichier <strong>local</strong>.</p> <p>Il est possible de n'utiliser aucun de ces deux handlers et de laisser un module se charger de cette mise à jour selon son propre fonctionnement.</p> <p>Pour cela, lorsque l'on transmets le tableau d'informations au hook <code>actionListModules</code>, on peut omettre l'entrée <code>download_url</code>.
Ceci aura pour effet de retirer le paramètre <code>source</code> de l'URL de mise à jour et dès lors aucun handlers ne pourra se charger de la source, puisque inexistante.</p> <p>Pour une raison que nous expliquerons plus tard, nous n'utiliserons pas cette technique.</p> <p>Modifions dès lors le trait pour télécharger l'archive en amont sur le disque et ainsi utiliser un handler local.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getDownloadUrl</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'assets'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'assets'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'assets'</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$asset</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$assetName</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'.zip'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$asset</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string single-quoted-string">'application/zip'</span> <span class="token operator">==</span> <span class="token variable">$asset</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content_type'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">==</span> <span class="token variable">$assetName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span>\<span class="token constant">_PS_CACHE_DIR_</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'downloads/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mkdir</span><span class="token punctuation">(</span>\<span class="token constant">_PS_CACHE_DIR_</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'downloads/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token variable">$archive</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">file_get_contents_curl</span><span class="token punctuation">(</span><span class="token variable">$asset</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getGithubHeaders</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">file_put_contents</span><span class="token punctuation">(</span>\<span class="token constant">_PS_CACHE_DIR_</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'downloads/'</span> <span class="token operator">.</span> <span class="token variable">$asset</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$archive</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> \<span class="token constant">_PS_CACHE_DIR_</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'downloads/'</span> <span class="token operator">.</span> <span class="token variable">$asset</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>On pourra remarquer que nous passons désormais un paramètre à la méthode <code>getGithubHeaders()</code> que nous modifions comme suit :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getGithubHeaders</span><span class="token punctuation">(</span><span class="token variable">$downloadMode</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token variable">$headers</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'http'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
      <span class="token string single-quoted-string">'method'</span><span class="token operator">=&gt;</span> <span class="token string double-quoted-string">&quot;GET&quot;</span><span class="token punctuation">,</span>
      <span class="token string single-quoted-string">'header'</span><span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string double-quoted-string">&quot;X-GitHub-Api-Version: 2022-11-28&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$downloadMode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$headers</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'http'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'header'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'Accept: application/vnd.github+json'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token variable">$headers</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'http'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'header'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'Accept: application/octet-stream'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token variable">$headers</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="probleme-n°3-la-desactivation-des-hooks"><a href="#probleme-n°3-la-desactivation-des-hooks" class="header-anchor">#</a> Problème n°3 : la désactivation des hooks</h4> <p>Précédemment, nous avons vu qu'il était possible de n'indiquer <strong>aucune source</strong> et de laisser un module se charger d'<strong>opérer lui-même</strong> le téléchargement du fichier distant et de l'extraire.</p> <p>Tout est à portée de main au sein de PrestaShop pour réaliser cette opération.</p> <p><em>Sauf que...</em></p> <p>Il nous faudrait nous baser sur le seul hook disponible et appellé lors d'une mise à jour souhaitée : <code>actionBeforeUpgradeModule</code>.
Jusque là, rien de bien contraignant.</p> <p><em>Oui, mais...</em></p> <p>Comme vous vous en douterez surement - <em>au vu du titre de cette section</em> - il s'avère que cette opération n'est en réalité pas possible au sein du même module du fait que <strong>l'ensemble des hooks associés au module mis à jour sont désactivés</strong>.</p> <h4 id="probleme-n°4-les-repos-prives"><a href="#probleme-n°4-les-repos-prives" class="header-anchor">#</a> Problème n°4 : les repos privés</h4> <div class="alert alert-warning">
  Avant de débuter cette section, rappellons avant tout qu'un token GitHub est une information privée et sensible. Toutes les alternatives mentionées et les décisions de les utiliser doivent êtres considérées avec le plus grand soin.
</div> <p>Notre approche, jusque là, peut convenir pour l'ensemble des modules open-source publiés sous GitHub et qui sont sous des <strong>repos publiques</strong>.</p> <p>Dès lors que l'on souhaite embarquer la découverte des mises à jours dans un module qui sera exclusivement privé, nous sommes confrontés à un problème de taille : évidemment, nul ne peut accéder aux informations de dernières releases et aux assets associés à celles-ci.</p> <p>Notre appel à l'API de GitHub nécessite dès lors le <strong>passage d'un token</strong>.</p> <div class="alert alert-warning">
  Malgré le caractère privé du module, un token étant strictement confidentiel, il est vivement déconseillé voir interdit d'embarquer ce dernier en dur.
</div> <p>Modifions notre trait pour utiliser un fichier <strong>.env</strong> afin de placer notre token dans un fichier séparé qui pourra être inclus dans le fichier <strong>.gitignore</strong>.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>Dotenv<span class="token punctuation">\</span>Dotenv</span><span class="token punctuation">;</span>

<span class="token keyword">trait</span> <span class="token class-name-definition class-name">UpgradeManager</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">getGithubToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$envVars</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Dotenv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function"><span class="token punctuation">\</span>file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getLocalPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.env'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$envVars</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'GITHUB_TOKEN'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token variable">$envVars</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'GITHUB_TOKEN'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Modifions également notre tableau d'options pour modifier l'en-être envoyée à GitHub :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getGithubHeaders</span><span class="token punctuation">(</span><span class="token variable">$downloadMode</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token variable">$headers</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'http'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
      <span class="token string single-quoted-string">'method'</span><span class="token operator">=&gt;</span> <span class="token string double-quoted-string">&quot;GET&quot;</span><span class="token punctuation">,</span>
      <span class="token string single-quoted-string">'header'</span><span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string double-quoted-string">&quot;Authorization: Bearer &quot;</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getGithubToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string double-quoted-string">&quot;X-GitHub-Api-Version: 2022-11-28&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$downloadMode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$headers</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'http'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'header'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'Accept: application/vnd.github+json'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token variable">$headers</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'http'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'header'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'Accept: application/octet-stream'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token variable">$headers</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Et, pour finir, notre fichier <code>.env</code> comme suit :</p> <div class="language- extra-class"><pre class="language-text"><code># .env
GITHUB_TOKEN=&quot;ghp_xxxx&quot;
</code></pre></div><div class="alert alert-info">
  Il est également possible d'envisager de regarder après un fichier .env plus générique que celui fourni dans le module directement.
</div> <h3 id="deuxieme-approche-module-de-distribution"><a href="#deuxieme-approche-module-de-distribution" class="header-anchor">#</a> Deuxième approche : module de distribution</h3> <p>Notre première approche nous aura permis de déceler plusieurs problématiques :</p> <ul><li>l'impossibilité d'utiliser une source distante (<strong>issue de GitHub</strong>) ;</li> <li>la nécessite d'<strong>embarquer un trait</strong> et d'en <strong>changer le namespace</strong> ;</li> <li>la <strong>gestion du token</strong> GitHub pour chaque module.</li></ul> <p>Dans cette seconde approche, nous allons donc réaliser un dérivé du module de distribution de PrestaShop, à la nuance près que nous nous passerons d'une source de syndication externe.</p> <div class="alert alert-warning">
  Comme pour notre première approche, nous omettrons la partie découverte et installation de modules non présent sur le disque.
</div> <h4 id="configuration-du-service"><a href="#configuration-du-service" class="header-anchor">#</a> Configuration du service</h4> <p>Puisque nous allons développer un module annexe, nous sommes plus libre sur la structure et la configuration de ce dernier.</p> <p>Nous allons donc pouvoir utiliser un service en lieu et place d'un trait.</p> <p>En voici son fichier de configuration :</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">ps_cache_dir</span><span class="token punctuation">:</span> <span class="token tag">!php/const</span> _PS_CACHE_DIR_

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">ghupgrademanager.upgrade_manager</span><span class="token punctuation">:</span>
    <span class="token key atrule">class</span><span class="token punctuation">:</span> PrestaShop\Module\GitHubUpgradeManager\UpgradeManager
    <span class="token key atrule">arguments</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'@ghupgrademanager.circuit_breaker'</span>
      <span class="token punctuation">-</span> <span class="token string">'@prestashop.module.factory.sourcehandler'</span>
      <span class="token punctuation">-</span> <span class="token string">'%ps_cache_dir%'</span>
    <span class="token key atrule">public</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><div class="alert alert-warning">
  L'illustration du fichier de configuration est incomplète.
</div> <p>Vous pouvez consulter la source complète sur le <a href="https://github.com/PrestaEdit/ghupgrademanager" target="_blank" rel="noopener noreferrer">repo correspondant<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="alert alert-info">
  prestashop/circuit-breaker
</div> <p>L'utilisation du package <a href="https://github.com/PrestaShop/circuit-breaker" target="_blank" rel="noopener noreferrer">prestashop/circuit-breaker<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> est vivement recommandée afin de <strong>ne pas bloquer le back office en cas d'indisponibilité</strong> de l'API de GitHub.</p> <p>Nous n'avons pas besoin de l'ajouter comme dépendance de notre module, celui-ci est inclus par défaut dans PrestaShop depuis la version 1.7.7.0.</p> <p><em>Son implémentation fera l'objet d'un article à part entière.</em></p> <h4 id="implementation-du-service"><a href="#implementation-du-service" class="header-anchor">#</a> Implémentation du service</h4> <p>Le service étant significativement similaire à notre trait de la première approche, à l'exception de l'ajout du <code>CircuitBreaker</code> et de quelques menues adaptations, je vous invite à consulter <a href="https://github.com/PrestaEdit/ghupgrademanager/blob/main/src/UpgradeManager.php" target="_blank" rel="noopener noreferrer">son code<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> directement sur GitHub.</p> <h4 id="ajout-du-token-github"><a href="#ajout-du-token-github" class="header-anchor">#</a> Ajout du token GitHub</h4> <div class="alert alert-warning">
  Avant de débuter cette section, rappellons avant tout qu'un token GitHub est une information privée et sensible. Toutes les alternatives mentionées et les décisions de les utiliser doivent êtres considérées avec le plus grand soin.
</div> <p>Puisqu'il s'agit d'un secret, je vous invite à utiliser les <strong>variables chiffrées</strong> prévues à cet effet :</p> <div class="language-bash extra-class"><pre class="language-bash"><code>php bin/console secrets:set GITHUB_TOKEN
</code></pre></div><p>Sinon, il est possible d'utiliser un fichier <code>.env</code> à la racine du PrestaShop ou encore directement dans le dossier du module pour y ajouter la variable <code>GITHUB_TOKEN</code>.</p> <p>Dans la configuration de nos services, nous trouverons dès lors :</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">env(GITHUB_TOKEN)</span><span class="token punctuation">:</span> <span class="token string">''</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">ghupgrademanager.upgrade_manager</span><span class="token punctuation">:</span>
    <span class="token key atrule">class</span><span class="token punctuation">:</span> PrestaShop\Module\GitHubUpgradeManager\UpgradeManager
    <span class="token key atrule">arguments</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'@ghupgrademanager.circuit_breaker'</span>
      <span class="token punctuation">-</span> <span class="token string">'@prestashop.module.factory.sourcehandler'</span>
      <span class="token punctuation">-</span> <span class="token string">'%ps_cache_dir%'</span>
      <span class="token punctuation">-</span> <span class="token string">'%env(GITHUB_TOKEN)%'</span>
    <span class="token key atrule">public</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>Et dans notre service :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name-definition class-name">UpgradeManager</span>
<span class="token punctuation">{</span>
  <span class="token comment">/** @var string */</span>
  <span class="token keyword">private</span> <span class="token variable">$githubToken</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span>
    <span class="token class-name type-declaration">CircuitBreakerInterface</span> <span class="token variable">$circruitBreaker</span><span class="token punctuation">,</span>
    <span class="token class-name type-declaration">SourceHandlerFactory</span> <span class="token variable">$sourceHandlerFactory</span><span class="token punctuation">,</span>
    <span class="token keyword type-hint">string</span> <span class="token variable">$cacheDirectory</span><span class="token punctuation">,</span>
    <span class="token keyword type-hint">string</span> <span class="token variable">$githubToken</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">circruitBreaker</span> <span class="token operator">=</span> <span class="token variable">$circruitBreaker</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">sourceHandlerFactory</span> <span class="token operator">=</span> <span class="token variable">$sourceHandlerFactory</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">cacheDirectory</span> <span class="token operator">=</span> <span class="token function">rtrim</span><span class="token punctuation">(</span><span class="token variable">$cacheDirectory</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">githubToken</span> <span class="token operator">=</span> <span class="token variable">$githubToken</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">getGithubToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">githubToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">githubToken</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_file</span><span class="token punctuation">(</span><span class="token constant">_PS_ROOT_DIR_</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/.env'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token variable">$envVars</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Dotenv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function"><span class="token punctuation">\</span>file_get_contents</span><span class="token punctuation">(</span><span class="token constant">_PS_ROOT_DIR_</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/.env'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$envVars</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'GITHUB_TOKEN'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$envVars</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'GITHUB_TOKEN'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_file</span><span class="token punctuation">(</span><span class="token constant">_PS_MODULE_DIR_</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'ghupgrademanager/.env'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token variable">$envVars</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Dotenv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function"><span class="token punctuation">\</span>file_get_contents</span><span class="token punctuation">(</span><span class="token constant">_PS_MODULE_DIR_</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'ghupgrademanager/.env'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$envVars</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'GITHUB_TOKEN'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$envVars</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'GITHUB_TOKEN'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="probleme-n°1-la-decouverte-des-modules"><a href="#probleme-n°1-la-decouverte-des-modules" class="header-anchor">#</a> Problème n°1 : la découverte des modules</h4> <p>Puisque nous ne passons pas par une API externe pour fournir une liste des repos GitHub concernés par l'ensemble des modules dont nous souhaiterions découvir les mises à jour, il nous faut trouver un moyen de les <strong>transmettre au module de distribution</strong>.</p> <p>On pourrait bien entendu imaginer <strong>un tableau ancré dans le module</strong> que nous ferions varier au besoin.</p> <p>Certes, cela nécessiterait une mise à jour du module de distribution en premier lieu.</p> <p>Sans oublier que nous ne pourrions pas utiliser ce module pour gérer sa propre mise à jour, suite à la désactivation des hooks précédemment vue.</p> <p>Partons sur un principe commun au développement de modules PrestaShop : <strong>l'utilisation de hooks</strong>.</p> <div class="alert alert-info">
  L'utilisation d'une API externe est bien entendu recommandée dans ce cas-ci. Dans l'optique de fournir un module fonctionnement de lui-même, nous travaillerons différement son implémentation.
</div> <p>Modifions dès lors le service comme suit :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">/**
 * @return array&lt;array&lt;string, string&gt;&gt;
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getModulesList</span><span class="token punctuation">(</span><span class="token variable">$cache</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">array</span>
<span class="token punctuation">{</span>
  <span class="token variable">$modules</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token variable">$cachedFile</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">cacheDirectory</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/github-upgrade-manager/'</span> <span class="token operator">.</span> <span class="token class-name static-context">Tools</span><span class="token operator">::</span><span class="token function">hashIV</span><span class="token punctuation">(</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'_'</span><span class="token punctuation">,</span> <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>Context</span><span class="token operator">::</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token property">shop</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$cachedFile</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token variable">$modules</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$cachedFile</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$modules</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$modules</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token variable">$modules</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token variable">$repositories</span> <span class="token operator">=</span> <span class="token class-name static-context">Hook</span><span class="token operator">::</span><span class="token function">exec</span><span class="token punctuation">(</span>
    <span class="token string single-quoted-string">'actionRegisterGitHubAutoUpgrade'</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token constant">null</span><span class="token punctuation">,</span>
    <span class="token constant boolean">true</span><span class="token punctuation">,</span>
    <span class="token constant boolean">true</span><span class="token punctuation">,</span>
    <span class="token constant boolean">false</span><span class="token punctuation">,</span>
    <span class="token constant">null</span><span class="token punctuation">,</span>
    <span class="token constant boolean">true</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$repositories</span> <span class="token keyword">as</span> <span class="token variable">$moduleName</span> <span class="token operator">=&gt;</span> <span class="token variable">$repository</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$latestRelease</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getLatestRelease</span><span class="token punctuation">(</span><span class="token variable">$moduleName</span><span class="token punctuation">,</span> <span class="token variable">$repository</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$latestRelease</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token variable">$attributes</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token variable">$moduleName</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'version_available'</span> <span class="token operator">=&gt;</span> <span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'version_available'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'archive_url'</span> <span class="token operator">=&gt;</span> <span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'download_url'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'asset_url'</span> <span class="token operator">=&gt;</span> <span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'asset_url'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'changeLog'</span> <span class="token operator">=&gt;</span> <span class="token variable">$latestRelease</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'changeLog'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token variable">$modules</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$attributes</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$cachedFile</span><span class="token punctuation">,</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$modules</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token variable">$modules</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">downloadModule</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$moduleName</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
<span class="token punctuation">{</span>
  <span class="token variable">$modules</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getModulesList</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$modules</span> <span class="token keyword">as</span> <span class="token variable">$module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$module</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token variable">$moduleName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">doDownload</span><span class="token punctuation">(</span><span class="token variable">$module</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Au sein de notre module concerné :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">hookActionRegisterGitHubAutoUpgrade</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'PrestaEdit/passwordgenerator'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>N'oublions pas d'ajouter l'enregistrement du hook au moment de l'installation et éventuellement dans un fichier d'upgrade.</p> <div class="alert alert-info">
  Nous avons ajouté un système de cache permettant d'obtenir la liste des modules au moment de la gestion de la demande de mise à jour.
Sans quoi le hook actionRegisterGitHubAutoUpgrade du module cible serait désactivé et donc non listé.
</div> <h4 id="probleme-n°2-la-compatibilite-des-modules"><a href="#probleme-n°2-la-compatibilite-des-modules" class="header-anchor">#</a> Problème n°2 : la compatibilité des modules</h4> <p>N'utilisant pas une source de syndication externe pour obtenir la liste des modules et ainsi agrégé les données obtenues, nous ne pouvons garantir que la dernière release d'un module soit compatible avec la version de PrestaShop utilisée.</p> <p>Une vérification de cette plage de compatibilité devrait être exercée en supplément.</p> <h2 id="pour-aller-plus-loin"><a href="#pour-aller-plus-loin" class="header-anchor">#</a> Pour aller plus loin</h2> <p>Ceci est avant tout un POC permettant une utilisation directe. Nous pourrions modifier plus en profondeur le module afin notamment de gérer plusieurs tokens GitHub ou encore d'autres sources de données (Gitlab, BitBucket, ...).</p> <p>L'idée de cet article est avant tout de pointer les possibilités et problématiques rencontrées lors du développement.</p> <div class="alert alert-info">
  A vos idées !
</div> <h3 id="marketplace"><a href="#marketplace" class="header-anchor">#</a> Marketplace</h3> <p>Sur cette même base, nous pourrions évoquer l'idée d'un module de marketplace ou, comme je préfère l'appeller, de syndication externe.</p> <p>Couplé à une API permettant à un éditeur tiers de renseigner une nouvelle version d'un module - imaginons un module gratuit en libre téléchargement sur le site de l'éditeur -, il serait possible également de faciliter la gestion de la découverte de modules.</p> <div class="alert alert-info">
  Lors de développement, il est habituel d'avoir un ensemble d'idées nouvelles. Le plus important restant à concrétiser les concepts.
</div> <blockquote class="twitter-tweet"><p lang="fr" dir="ltr">Suis-je le seul à dire à voix haute et affirmer avec une certitude quasi inébranlable que 2023, maximum début 2024, verra naître une nouvelle marketplace de modules <a href="https://twitter.com/hashtag/PrestaShop?src=hash&amp;ref_src=twsrc%5Etfw">#PrestaShop</a> et, aussi, que des projets du type de PrestaTrust pourrait faire un retour fracassant (et utile !)? 🤔</p>— Jonathan Danse (@PrestaEdit) <a href="https://twitter.com/PrestaEdit/status/1511816489225048078?ref_src=twsrc%5Etfw">April 6, 2022</a></blockquote> <script async="async" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> <blockquote data-theme="light" class="twitter-tweet"><p lang="fr" dir="ltr">Il y a finalement plus d'un an, j'évoquais l'idée d'une nouvelle marketplace pour <a href="https://twitter.com/hashtag/PrestaShop?src=hash&amp;ref_src=twsrc%5Etfw">#PrestaShop</a> (8.x).<br><br>Cette semaine, l'idée a germée différemment : permettre de centraliser les différentes sources de modules en un point central.<br><br>Ce soir, les prémices de ceci sont apparues. <a href="https://t.co/elgAuRd0pb">pic.twitter.com/elgAuRd0pb</a></p>— Jonathan Danse (@PrestaEdit) <a href="https://twitter.com/PrestaEdit/status/1648793881499115521?ref_src=twsrc%5Etfw">April 19, 2023</a></blockquote> <script async="async" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> <h3 id="liens"><a href="#liens" class="header-anchor">#</a> Liens</h3> <p>Sur le même thème, je vous invite à consulter l'article <a href="https://www.h-hennes.fr/blog/2023/06/21/prestashop-mettez-en-avant-vos-modules-dans-le-listing-des-modules-dans-ladministration/" target="_blank" rel="noopener noreferrer">&quot;Prestashop : Mettez en avant vos modules dans le listing des modules dans l’administration&quot;<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div></div></div></article> <div class="row justify-content-center" data-v-d07ae2ee><div class="col-md-9" data-v-d07ae2ee><!----> <!----></div></div> <div class="sticker vuepress-toc" data-v-d07ae2ee><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#preambule" title="Préambule">Préambule</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#de-nouveaux-hooks" title="De nouveaux hooks">De nouveaux hooks</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#implementation-technique" title="Implémentation technique">Implémentation technique</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#premiere-approche-standalone" title="Première approche : standalone">Première approche : standalone</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#deuxieme-approche-module-de-distribution" title="Deuxième approche : module de distribution">Deuxième approche : module de distribution</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#pour-aller-plus-loin" title="Pour aller plus loin">Pour aller plus loin</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#marketplace" title="Marketplace">Marketplace</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#liens" title="Liens">Liens</a></div></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ed9e6311.js" defer></script><script src="/assets/js/6.20402219.js" defer></script><script src="/assets/js/3.d4855d28.js" defer></script><script src="/assets/js/24.f82cd95c.js" defer></script><script src="/assets/js/8.14af2056.js" defer></script><script src="/assets/js/9.0ace11ef.js" defer></script>
  </body>
</html>
